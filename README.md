# Zaloa

Zaloa takes input [terrain tiles](https://aws.amazon.com/public-datasets/terrain/) and merges them together.

It is designed to be run as middleware to dynamically generate alternate tile sizes from 256px sources.

## Sizes and tilesets

Zaloa uses two tilesets as its source:

1. terrarium
2. normal

Supports 512, and buffered variants of 256, namely 260 and 516. The variants have a 2 pixel buffer on each edge.

## Tile Generation

The larger tiles are generated by sourcing the relevant neighbors from the 256px sources.

In the diagrams below, `o` is the source tile, and the `x`s represent the neighbors used.

### 512

```
o x
x x
```

### 260

```
x x x
x o x
x x x
```

### 516

```
x x x x
x O o x
x o o x
x x x x
```

## Edge Cases

When on the "edge", there isn't a neighboring tile to source. Zaloa's behavior is:

* column edge: wrap around and use the tile from the other "side".

eg: The left neighbor of 2/0/2 will be 2/3/2

* row edge: the source tile is "copied" into the necessary location.

eg: The top neighbor of 2/2/0 is 2/2/0 itself, ie the top 2 rows of pixels are re-used as the buffer.

## Development

We use [Pipenv](http://pipenv.readthedocs.io/en/latest/) to manage dependencies. To develop on this software, you'll need to get [pipenv installed first](http://pipenv.readthedocs.io/en/latest/install/#installing-pipenv). Once you have pipenv installed, you can install the dependencies:

```
pipenv install --dev
```

With the dependencies installed, you can enter the virtual environment so your dependencies are used:

```
pipenv shell
```

## Configuration

The important bits of configuration are set in `config.py` using environment variables:

| Environment Variable Name | Description |
|---|---|
`S3_BUCKET` | Specifies the S3 bucket to use when requesting metatiles.
`REQUESTER_PAYS` | A boolean flag in configuration for REQUESTER_PAYS. Set it to `true` to use a [requester pays](https://docs.aws.amazon.com/AmazonS3/latest/dev/RequesterPaysBuckets.html) bucket for metatiles.

## Running locally

Once you have the dependencies installed as described above, you can use the Flask command line tool to run the server locally.

```
FLASK_DEBUG=true FLASK_APP=zaloa.py flask run
```

The `FLASK_` environment variables specified before the `flask run` command are used to enable debug mode (`FLASK_DEBUG`) and to tell Flask's command line helper where the app code is (`FLASK_APP`). You can also include the other environment variables from the Configuration section here, too. When I run this locally to develop I run:

```
AWS_PROFILE=nextzen \
FLASK_DEBUG=true \
FLASK_APP=server.py \
S3_BUCKET=elevation-tiles-prod \
flask run
```

## Deploying

This server can run in a normal WSGI environment (on Heroku, with gunicorn, etc.) but it was designed with Lambda in mind. We use [Zappa](https://github.com/Miserlou/Zappa) to coordinate the package and deploy to Lambda. To get this to lambda, I ran:

1. Setup Zappa for your account and AWS environment:

   ```
   zappa init
   ```

1. Ask Zappa to deploy to your environment:

   ```
   zappa deploy dev
   ```

1. Once Zappa deploys your code, it will not work until you set the configuration variables mentioned in the Configuration section above. You can set those via [your Zappa configuration file](https://github.com/Miserlou/Zappa#remote-environment-variables) or on the [AWS Lambda console](https://console.aws.amazon.com/lambda/home).

### Improving performance with a CDN

Since the terrain tiles rarely change, a content delivery network (CDN) with edge caching (like [Amazon's CloudFront](https://aws.amazon.com/cloudfront/)) will greatly improve performance. By default, the API Gateway service used by Zappa will use CloudFront, [but in a custom way that doesn't allow caching](https://stackoverflow.com/questions/32825413/how-do-you-add-cloudfront-in-front-of-api-gateway). To work around this, API Gateway supports ["regional" API Gateway](https://forums.aws.amazon.com/thread.jspa?threadID=195290), but Zappa doesn't support the regional endpoint.

To allow standard CloudFront caching, do the following:

1. Run a standard Zappa deploy as described above. This will create an API Gateway in AWS with an Endpoint Type of "Edge Optimized". You can see those in your [AWS API Gateway Console](https://console.aws.amazon.com/apigateway/home?region=us-east-1#/apis).
1. Click the gear icon in the upper right for the API that you want to put a CloudFront distribution in front of.
1. Change the "Endpoint Type" dropdown to "Regional" and click "Save" to commit the change.
1. Click on the API's name to see the Resources list for the API. On the left click "Dashboard" to reveal the Invoke URL at the top. It'll look like `https://xyz.execute-api.us-east-1.amazonaws.com/prod`. Note that URL to use in a later step.
1. Head to your CloudFront distribution and add an Origin.
1. In the Origin Domain Name text field, enter the domain name from the Invoke URL. In the example case it is `xyz.execute-api.us-east-1.amazonaws.com`.
1. In the Origin Path text field, enter the path component from the Invoke URL. In the example case it is `/prod`. The leading slash is important.
1. Toggle the "HTTPS Only" option and click the blue "Create" button.
